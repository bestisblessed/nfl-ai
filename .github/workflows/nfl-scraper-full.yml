name: NFL Full Scraper

on:
  schedule:
    - cron: '0 23 * * 6'     # Run every Saturday at 6 PM EST (11 PM UTC)
  workflow_dispatch: # Allow manual runs

jobs:
  scrape:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install pandas>=2.0.0 requests>=2.31.0 beautifulsoup4>=4.12.0 numpy>=1.24.0 lxml
        
      # chmod +x scrape.sh
      # ./scrape.sh
    - name: Run Full NFL Scraper
      run: |
        cd Scrapers
        echo "üìÅ Creating necessary directories..."
        mkdir -p data/rosters data/player-stats data/SR-game-logs data/SR-opponent-game-logs data/SR-team-stats data/SR-team-conversions data/SR-passing-rushing-receiving-game-logs data/SR-defense-game-logs data/SR-scoring-tables data/SR-schedule-and-game-results data/SR-box-scores
        
        echo "‚è±Ô∏è Setting up rate limiting to avoid 403 errors..."
        export SCRAPER_DELAY=5  # 5 second delays between requests
        export USER_AGENT="Mozilla/5.0 (compatible; NFL-Scraper/1.0)"
        
        echo "‚è≥ Waiting 30 seconds before starting to let rate limits reset..."
        sleep 30
        
        echo "üöÄ Starting ScraperFinal.py..."
        python -u ScraperFinal.py
        if [ $? -ne 0 ]; then
          echo "‚ùå ScraperFinal.py failed"
          exit 1
        fi
        echo "‚úÖ ScraperFinal.py completed successfully"
        
        echo "üöÄ Starting ScraperFinal-PFR.py..."
        python -u ScraperFinal-PFR.py
        if [ $? -ne 0 ]; then
          echo "‚ùå ScraperFinal-PFR.py failed"
          exit 1
        fi
        echo "‚úÖ ScraperFinal-PFR.py completed successfully"
      continue-on-error: false
        
    - name: Check for data files
      run: |
        echo "Checking data directory..."
        ls -la Scrapers/data/
        echo ""
        echo "Checking final_data directory..."
        ls -la Scrapers/final_data/
        echo ""
        echo "Checking final_data_pfr directory..."
        ls -la Scrapers/final_data_pfr/
        
    - name: Upload data files
      uses: actions/upload-artifact@v4
      with:
        name: nfl-full-data-${{ github.run_number }}
        path: |
          Scrapers/data/
          Scrapers/final_data/
          Scrapers/final_data_pfr/
        
    - name: Commit and push data
      run: |
        git config --local user.email "tyler.durette@gmail.com"
        git config --local user.name "bestisblessed"
        git add Scrapers/data/ Scrapers/final_data/ Scrapers/final_data_pfr/
        git diff --staged --quiet || git commit -m "Update NFL full data - $(date)"
        git push